# 104 分层结构、协议、接口、服务

## 一. 分层

当计算机之间进行数据传送时，需要经过复杂的过程。
最简单的情况，连接在网络上的两台计算机要互相传送文件，则需要经过：

1. 发起通信的计算机必须将数据通信的通路进行**激活**（activate）。
   激活，指发出一些信令，保证要传送的计算机数据能在这条通路上正确发送和接受。
2. 告诉网络如何识别接收数据的计算机。
3. 发起通信的计算机必须查明对方计算机是否已开机，并且与网络连接正常。
4. 发起通信的计算机中的应用程序必须弄清楚，在对方计算机中的文件管理程序是否已做好接收文件和存储文件的准备工作。
5. 若计算机的文件格式不兼容，则至少其中一台计算机应完成格式转换功能。
6. 对出现的各种差错和意外事故，如数据传送错误、重复或丢失，网络中某个结点交换机出现故障等，应当由可靠的措施保证对方计算机最终能够收到正确的文件。

还可以举出一些要做的其他工作，但不久多说了。

可见，这些工作比较复杂。
分层，就是将庞大而复杂的问题，转化为若干比较易于研究和处理的较小的局部问题。

早期各个公司有着各自不同分层的体系结构，于是不同公司间的设备很难互连。
国际标准化组织 ISO 尝试提出了**开放系统互连基本参考模型 OSI/RM**（Open System Interconnection Reference Model），并于 1983 年形成了正式文件，即著名的 ISO 7498 国际标准，也就是所谓的七层协议结构。
但由于种种原因，虽然该 ISO 标准是法定标准，但实际上，TCP/IP 才是使用最广泛的事实标准。

## 二. 协议与划分层次

在计算机网络中要做到有条不紊地交换数据，需要遵守一些事先约定好的规则，**这些规则明确规定了所交换数据的格式以及有关的同步问题**。
此处的**同步**，含有**时序**的意思，是指在一定的条件下应该发送什么事情，例如接收到信息后应该发送一个应答信息。

这些为进行网络中的数据交换而建立的规则、标准或约定，称为**网络协议**，简称**协议**。
网络协议又三个要素组成：

1. 语法：数据与控制信息的结构或格式；
2. 语义：需要发出何种控制信息，完成何种动作记忆做出何种响应；
3. 同步：时间实现顺序的详细说明。

**分层的优点**：（划分层次的原则：怎么划分层次：）

1. 各层间是独立的；

   某一层并不需要知道它的下一层是如何实现的，而仅仅需要知道下一层通过层间接口所提供的服务。

2. 灵活性好；

   当某一层发生变化时，只要层间接口无变动，则该层的上下层均不受影响。

3. 结构上可分割开；

   使得每层都可以采用最适合该层的技术来实现。

4. 易于实现和维护；

   因为一个庞大而复杂的系统拆分成了若干相对独立的子系统了嘛。

5. 能促进标准化工作；

   层次划分后，每一层的应具有功能及其所应提供的服务都有了精确的说明，所以利于标准化。

通常各层所要完成的功能包含但不限于以下的一种或多种：

1. 差错控制：使得相应层次对等方的通信更可靠；
2. 流量控制：发送端的发送速率必须使接收端来得及接收，不要太快；
3. 分段和重装：发送端将要发送的数据块划分为更小的单位，在接收端将其还原；
4. 复用和分用：发送端的几个高层会话复用一条底层连接，数据传送结束后释放连接；
5. 连接建立和释放：交换数据前先建立一条逻辑连接，数据传送结束后释放连接。

分层当然也有缺点，例如有些功能会在不同层次中重复出现，产生额外开销。

**计算机网络的各层及其协议的集合**就是网络的**体系结构**（architecture）。
换个句式：**计算机网络的体系结构就是这个计算机网络及其构件所完成的功能的精确定义**。

显然，体系结构是**抽象的**。实现（impementation）才是具体的，是真正在运行的计算机硬件和软件。

## 三. 具有五层协议的体系结构

放在后面两节讲。

## 四. 实体、协议、服务、服务访问点

**实体**，指任何可发送或接收信息的硬件或软件进程。
在分层结构中，第 n 层的活动元素称为 **n 层实体**，同一层的实体叫**对等实体**。

**协议**，是控制两个（或多个）对等实体进行通信的规则的集合。
协议是 "水平的"，是对等实体之间的通信规则。

**服务**，在协议的控制下，两个对等实体间的通信，使得本层能够向上一层提供服务。要实现本层协议，也还需要使用下一层所提供的服务。
服务是 "垂直的"，是下层提供给上层，可供上层使用的功能（并非全部下层功能都是服务）。
上层使用下层所提供的服务必须通过与下层交换一些命令，这些命令在 OSI 中称为**服务原语**。

**服务访问点 SAP** （Service Access Point），在同一系统中相邻两层的实体进行交互（交换信息）的地方。
SAP 是一个**抽象的**概念，OSI 将层与层之间交换的数据的单位称为**服务数据单元 SDU**（Service Data Unit）。

一些细节：
第 n 层的两个实体之间通过第 n 层的协议进行通信。
第 n+1 层的两个实体之间通过第 n+1 层的协议进行通信。
每一层的协议都是不同的。

使用第 n 层实体提供的服务的第 n+1 层实体，称为**服务用户**。
就是提供服务的层的上一层就是用户嘛。

当第 n 层实体对第 n+1 层实体提供服务时，不仅包含第 n 层的功能，也包含更下层的功能。

2021.01.21