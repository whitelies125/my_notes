# 303 差错控制

## 一. 差错的起因与分类

概括来说，传输中的差错都是由于噪声引起的。

全局性：由于线路本身电气特性所产生的**随机噪声**（热噪声），是信道固有的，随机存在的。
解决办法：提高信噪比来减少或避免干扰。

局部性：外界特定的短暂原因所造成的**冲击噪声**，是产生差错的主要原因。
解决办法：通常利用编码计数来解决。

差错分为：

1. 位错（比特差错）：

   比特位出错，1 变成 0，或 0 变成 1。

2. 帧错：

   丢失：发送 1，2，3 帧，只收到 1，3帧。
   重复：收到 1，2，2，3帧。
   失序：收到顺序为 1，3，2帧。

## 二. 差错控制的方式

在数据链路层，主要**处理位错（比特差错）**。

对于**比特差错**的差错控制，控制方法有两种，

1. **检错编码**：只发现错误，不能纠错。

   奇偶校验码，循环冗余校验码。

2. **纠错编码**：可发现错误，可纠正错误。

   海明码。

区分一下物理层与数据链路层的编码。
物理层的编码是针对单个比特，使之与码元对应。
数据链路层的编码是针对的是一组比特，使之与另一组比特对应。

**冗余编码**：指在数据发送前，先按某种关系附加上一定的冗余位，构成一个符合某一规则的码字后再发送。冗余位的 bit 取决于有效数据，即根据规则随有效数据变化而变化。接收端根据收到的码字是否仍符合原规则，从而判断是否出错。

### 2.1 奇偶校验码

见<计算机组成原理>—2数制与编码—205校验原理、奇偶校验码。

奇/偶校验码，只能检查出奇/偶数个 bit 错误，检错能力为 50%。

### 2.2 CRC 循环冗余校验码

见<计算机组成原理>—2数制与编码—207循环冗余校验码。

根据生成多项式写出其二进制，将原本发送的数据对生成多项式的二进制进行**模 2 运算**，得到的余数 R 拼接在原本数据后发送出去。

这种为了检错而添加的**冗余码**（余数 R）常称为**帧检测序列 FCS（Frame Check Sequence）**。

接受端接受到数据后，计算余数为 0 ，则没有出错，接收该帧；
余数不为 0 ，则出错，不接受，丢弃该帧。

FCS 的生成以及接收端 CRC 检验都是由**硬件实现**，处理很迅速，因此不会延误数据传输。

> 在数据链路层若**仅仅**使用循环冗余检验 CRC 差错检测技术，则只能做到对帧的**无差错接收**，即：" **凡是接收端数据链路层接收的帧，我们都能以非常接近于 1 的概率认为这些帧在传输过程中没有产生差错** "。
> 接收端丢弃的帧虽然曾**收到**了，但最终还是因为有差错被丢弃，即没有被**接收**。
> 以上所述的可以**近似地**表述为（通常都是这样认为）：" **凡是接收端数据链路层接收的帧均无差错** " 。

其实 CRC 码是可以具备纠错功能的，但是王道<计网>视频里分为了检错编码，并说只有检错功能。
不过<计网>书上这里说的是：

> 在数据链路层若**仅仅**使用循环冗余检验 CRC 差错检测技术。

有个**若仅仅**，所以其实只是数据链路层只用了 CRC 的检错，而没有用（实现） CRC 的纠错功能吧。

为什么是概率非常接近于 1。
因为实际上这是数学证明的，当 CRC 码出错时，刚刚好数据传输出错了，余数也为 0 的概率太低了。所以实际生活中可以认为，余数为 0 的帧是没有出错的，可以接收。虽然严谨的从概率上来说，还是有可能是出错的。这大概就是理论与工程的区别吧。

目前在数据链路层广泛适用的是循环冗余校验码 CRC（Cyclic Redundancy Check）。

### 2.3 海明码

见<计算机组成原理>—2数制与编码—206海明码。

**补充：海明码纠错 $d$ 位，需要码距为 $2d+1$ 的编码方案；检错 $d$ 位，只需要码距为 $d+1$ 。** 

## 三. 其他

注意的是，虽然认为数据链路层接收的帧都是没有比特差错的，但只是没有比特差错并等不同于就是**可靠传输**的功能。
因为传输差错分为：位错（比特差错）和帧错。
**可靠传输**指：发送端发送什么、接收端收到什么。

书上原话：

> 在过去 OSI 的观点是：必须让数据链路层向上提供可靠传输。因此在 CRC 检错的基础上，增加了**帧编号**、**确认**和**重传机制**。收到正确的帧就要向发送端发送确认。发送端在一定的期限内若没有收到对方的确认，就认为出现了差错，因而就进行重传，知道收到对方的确认为止。这种方法在历史上曾起到很好的作用。但现在的通信线路的质量已经大大提高了，由通信链路质量不好引起差错的概率已经大大降低。因此，现在互联网就采取了区别对待的方法：
>
> 对于通信质量良好的有线传输链路，数据链路层协议不使用确认和重传机制，即不要求数据链路层向上提供可靠传输的服务。如果在数据链路层传输数据时出现了差错并且需要进行改正，那么改正差错的任务就有上层协议（例如，运输层的 TCP 协议）来完成。
>
> 对于通信质量较差的无线传输链路，数据链路层协议适用确认和重传机制，数据链路层向上提供可靠传输的服务。
>
> 实践证明，这样做可以**提高通信效率**。

2021.01.28