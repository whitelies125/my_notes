# 407 网络地址转换 NAT

网络地址转换 NAT（Network Address Translation）：在专用网连接到互联网的路由器上安装 NAT 软件，安转了 NAT 软件的路由器叫 **NAT 路由器**，它至少有一个有效的**外部全球 IP 地址**。

所有使用专用网中本地地址的主机，与外部通信时，都需要经过 NAT 路由器的网络地址转换才能通信。

如何转换？
在 NAT 路由器中有一个 NAT 转换表，如：

| WAN 端           | LAN 端            |
| ---------------- | ----------------- |
| 172.38.1.5:40001 | 192.168.0.3:30000 |
| 172.38.1.5:40002 | 192.168.0.4:30001 |

WAN 就是外网端，LAN 就是内网端。
: 冒号后面是端口，在后面传输层学。

这样一一对应起来。

如内网中发送一个分组给外网主机，该分组中有源地址，目的地址，当然还需要有端口号。
由内网主机发出给 NAT 路由器的分组中，源地址是该内网主机的内网 IP 地址，目的地址是外网主机的 IP 地址，端口号假设是 30000。
NAT 路由器通过端口 30000 接收到该分组，根据 NAT 转换表进行替换，将源地址替换为 NAT 路由器的外部全球 IP 地址，将端口号替换为对应的端口号 40001。然后发送到外网去。

2021.02.28

补充一个题：

> 假定一个 NAT 路由器的公网地址为 205.56.79.35，并且有如下表项：
>
> | 转换端口 | 源 IP 地址     | 源端口 |
> | -------- | -------------- | ------ |
> | 2056     | 192.168.32.56  | 21     |
> | 2057     | 192.168.32.56  | 20     |
> | 1892     | 192.168.48.26  | 80     |
> | 2256     | 192.168.55.106 | 80     |
>
> 它收到一个源 IP 地址为 192.168.32.56，源端口为 80 的分组，其动作是（__）
>
> A. 转换地址，将源 IP 变为 205.56.79.35，端口变为 2056，然后发送到公网。
>
> B. 添加一个新的条目，转换 IP 地址及接口然后发送到公网。
>
> C. 不转发，丢弃该分组
>
> D. 直接将分组转发到公网。
>
> 答案：C
>
> NAT 的表项需要管理员添加，这样才能控制一个内网到外网的网络连接。
>
> 题目中主机发送的分组在 NAT 表项中找不到，所以服务器不转发该分组。