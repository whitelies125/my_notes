# 410 ARP 协议

简略讲述一遍封装过程，省略细节：

应用层将要传输的文件，假设是一个 .pdf 文件，交给传输层。

传输层根据文件大小判断是否需要分段，假设将该报文分为了 3 个报文段，交给网络层。

网络层将报文段加上自己的 IP 地址，和目的 IP 地址（目的 IP 地址的确定在后续传输层再讲），需要 IP 数据报判断是否超过了最大传送单元 MTU，假定没有超过，不需要分组，交给数据链路层。

数据链路层将数据报加上 MAC 地址，自己的 MAC 地址，和目的主机的 MAC 地址。

就到这里，问题来了，目的 MAC 地址要怎么知道呢？
而且由于一个网络内，可能会新增和撤走一些主机，而 IP 地址是可分配的，MAC 地址是唯一的。

ARP 协议就是解决 IP 地址映射到 MAC 地址这个问题的。

## 一. ARP 协议（Address Resolution Protocol）

对于每一个主机、路由器，都设有一个 **ARP 高速缓存（ARP cache）**，里面有**本局域网**上的个主机和路由器的 IP 地址到 MAC 地址的映射表。
这些都是该主机目前知道的一些地址。

ARP cache 中的每一个映射地址项目都设置了**生存时间**（一般是 10-20min）。
超过了生存时间的项目就从 cache 中删除。

当主机 A 要向**本局域网**上的主机 B 发送 IP 数据报时，就现在 ARP cache 中查看有无主机 B 的 IP 地址，若有，则查出对应的 MAC 地址，将其写入 MAC 帧。

## 1. 目的 IP 地址在同一局域网内

如果没有呢。显然是会出现没有的情况的，比如主机 B 新加入该网络，或主机 A 刚开机。
这种情况下，主机 A 自动运行 ARP，按以下步骤找出主机 B 的 MAC 地址。

1. ARP 进程在本局域网上广播（目的 MAC 地址为 FF-FF-FF-FF-FF-FF）发送一个 **ARP 请求分组**。
   格式不细说，其主要内容为：主机 A 的 IP 地址，主机 A 的 MAC 地址，（想要查询其 MAC 帧的）主机 B 的 IP 地址。

2. 在本局域网上的所有主机上运行的 ARP 进程都收到此 ARP 请求分组。

3. 主机 B 的 IP 地址与 ARP 请求分组中要查询的 IP 地址一致，就收下这个 ARP 请求分组，并向主机 A 发送 **ARP 响应分组**，同时在这个 ARP 响应分组中写入自己的 MAC 地址，其主要内容为：主机 B 的 IP 地址，主机 B 的 MAC 地址。
   
   而其余主机由于与 ARP 请求分组中想要查询的 IP 地址不相符，都不响应这个 ARP 请求分组。
   
   注意，ARP 请求分组是**广播**，而 ARP 响应分组是普通的**单播**。
   
4. 主机 A 收到主机 B 的 ARP 响应分组后，就在其 ARP cache 中写入主机 B 的 IP 地址到 MAC 地址的映射。

当然，实际上，当主机 A 要给主机 B 发送数据报时，通常意味着接下来主机 B 也会向主机 A 发送数据报，所以主机 A 在 ARP 请求分组中，就写入主机 A 的 IP 地址和 MAC 地址，这样主机 B 收到 ARP 请求分组时，就顺带将主机 A 的 IP 地址到 MAC 地址的映射写入 ARP cache 了。

## 2. 目的 IP 地址不在同一局域网内

那么，如果目的 IP 地址的主机并不在局域网内呢。

1. 还是先查 ARP cache，发现没有，
   将目的 IP 地址与自己的子网掩码进行与运算，判断，发现不在一个网络内。
   （前面在同一局域网内没写这个操作，我猜也是应该是在第 1 步之前，也就是查询 ARP cache 里没有就判断是否在一个局域网。）

   对于局域网内的主机，并没有必要知道局域网外的 IP 地址对应的 MAC 帧。
   因为对外部网的通信都是通过路由器进行的。

2. 于是将该数据报发送给默认网关了，默认网关也就是这个网络的路由器。
   所以目的 MAC 地址填默认网关的 MAC 地址。

   获得默认网关的 MAC 地址与获得同一局域网主机的 MAC 地址方法一致：ARP cache 有就直接填，没有就向广播 ARP 请求分组。。

3. 路由器的收到数据报，解封装，查询路由表，

   如果在该路由器直接相连的网络中，则传送给目的主机。
   目的主机 MAC 地址的获得与获得同一局域网主机的 MAC 地址方法一致：ARP cache 有就直接填，没有就向目的主机所在网络广播 ARP 请求分组。

   如果下一跳是下一个路由器，则传送给下一跳路由器。
   目的主机 MAC 地址的获得与获得同一局域网主机的 MAC 地址方法一致：ARP cache 有就直接填，没有就向下一跳路由所在网络广播 ARP 请求分组。

   **再次封装中，源 IP 地址、目的 IP 地址不变，但源 MAC 地址变为路由器的 MAC 地址，目的 MAC 地址变为目的主机或下一跳路由器的 MAC 地址。**

2021.03.01
