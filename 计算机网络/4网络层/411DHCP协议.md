# 411 DHCP 协议

动态主机配置协议 DHCP 协议是**应用层**协议，放在这里网络层讲，主要是因为使用 DHCP 协议获得 IP 地址，网络层才能进行通信。

DHCP 协议使用**客户/服务器**方式，客户端和服务端通过广播方式进行交互，基于 **UDP**。

DHCP 提供**即插即用**联网的机制，主机可以从服务器动态获取 IP 地址、子网掩码、默认网关、DNS 服务器名词与其 IP 地址，运行**地址重用**，支持**移动用户加入网络**，支持**在用地址续租**。

即插即用：当网络新加入一台主机，主机从 DHCP 服务器中获取 IP 地址、子网掩码、默认网关、DNS 服务器名词与其 IP 地址。

地址重用：DHCP 服务器拥有 IP 地址池，对网络内的主机给于 IP 地址，当网络内主机退出网络后，回收 IP 地址，可再分配给其它主机。

在用地址续租：DHCP 动态分配地址有多种方式，常用的方式中，分配的 IP 地址有使用时限，DHCP 支持在用地址续租。

工作流程：

1. 主机广播 **DHCP 发现报文**。

   目的是寻找所处网络中的 DHCP 服务器。
   显然主机刚加入网络，是没有 DHCP 服务器的信息的，只能广播。

2. DHCP 服务器广播 **DHCP 提供报文**。

   DHCP 服务器**拟**分配给主机一个 IP 地址及相关配置（IP 地址租约期限等等），由广播的形式发送出去（毕竟主机都还没 IP 地址），
   网络内可能有多个 DHCP 服务器，所以可能会先后收到多个 DHCP 提供报文，不过主机会优先采用最先收到的 DHCP 提供报文中的配置。

   但现在主机还并不能使用该 IP 地址及相关配置。

3. 主机广播 **DHCP 请求报文**。

   DHCP 请求报文中有主机采用的配置的 DHCP 服务器的编号。
   这样的目的是，主机告知网络中的所有 DHCP 服务器，主机使用的是这个（最先收到的） DHCP 服务器提供的配置。
   而其他 DHCP 服务器没有收到自己编号的 DHCP 请求报文，可知道自己分配出去的 IP 地址并没有被使用，于是可分配给其它主机。

4. DHCP 服务器广播 **DHCP 确认报文**。

   DHCP 服务器收到 DHCP 请求报文后，由请求报文中的 MAC 地址，查询 DHCP 服务器中是否有租约记录，若有，则广播 DHCP 确认报文，告知主机可以正式使用这个 IP 地址及相关配置了。

显然，在主机收到 DHCP 确认报文后，才正式可以使用 IP 地址及其相关配置，所以 **DHCP 整个过程都是广播**。

自然，DHCP 使用 UDP 协议，而非 TCP。
因为 TCP 是建立连接的协议，而使用 DHCP 的场景，主机连 IP 地址都还没有，所以无法通过套接字建立连接（王道这么说的）。

2021.03.02

