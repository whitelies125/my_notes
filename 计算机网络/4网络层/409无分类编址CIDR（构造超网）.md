# 409 无分类编址 CIDR（构造超网）

虽然上一节的划分子网的方式，缓减了 IP 地址消耗殆尽的时间，但 IP 地址还是在 2017 年分配完了。

在当时 1992 年，人们就意识到了：

1. B 类地址已经分配了近一半，眼看快要分配完了。
2. 互联网主干网上的路由表中的项目数急剧增长。
3. IPv4 地址空间终将会全部耗尽。

考虑到这三个问题，IETF 研究出了**无分类编址**的方法来解决前两个问题，至于第三个问题，则是成立了 IPv6 工作组来研究解决新版本 IP 协议的问题。
IPv6 在后面讲，这里讲无分类编址。

## 一. CIDR

无分类编址方法的正式名字是**无分类域间路由选择 CIDR（Classless Inter-Domain Routing**，CIDR 的读音是 "sider"）。

CIDR 最主要的特点有两个：

1. CIDR 消除了传统的 A、B、C 类地址以及子网划分的概念，能更有效的分配 IP 地址。

   CIDR 将 IP 地址划分为前后两个部分。
   前面部分是**网络前缀（network-prefix）**（或简称前缀），用来指明网络；
   后面部分用来指明主机。
   即，IP 地址：（<网络前缀>，<主机号>）。

   CIDR 还使用**斜线记法（slash notation）**，或称为 CIDR 记法，即在 IP 地址后加上斜线 "/"，然后写上网络前缀所占位数。

2. CIDR 把网络前缀都相同的连续 IP 地址组成一个 **CIDR 地址块**。

   所以只要知道 CIDR 地址块中的任意一个地址，就可以知道这个地址快的起始地址（最小地址）和最大地址，以及地址块中的地址数。

   例如，已知 IP 地址 128.14.35.7/20 是某 CIDR 地址块中的一个地址，则可知前 20 位为网络前缀，该地址块的最小地址就是后 12 位（主机号）全为 0，最大地址就是后 12 位（主机号）全为 1，地址数为 $2^{12}$ 个。
   （当然，全 0 全 1 通常留作特殊用途，并不会作为主机 IP 地址。）

   则 IP 地址 128.14.35.7/20 所属的地址块就是 128.14.32.0/20。
   在不需要指出起始地址时，可把这样（网络前缀为 20bit ）的地址块简称为 /20 地址块。

为了更方便的进行路由选择，CIDR 使用 32 位的**地址掩码（address mask）**。也是由一串 1 和一串 0 组成。
地址掩码中，对应 IP 地址的网络前缀部分全为 1，对应 IP 地址的主机号部分全为 0。
斜线记法中，斜线后的数字就是地址掩码中 1 的个数。

虽然 CIDR 不使用子网了，但仍然有一些网络还使用子网划分和子网掩码，所以地址掩码也可一并称为**子网掩码**。
注意， CIDR 不使用子网，意指 CIDR 在其 IP 地址格式中，并没有特地指明若干位作为子网字段。
实际上，分配了一个 CIDR 地址块的单位，**仍然可以**在其内部网中**进行子网划分**。
子网同样也都只有一个网络前缀和一台主机号字段，但子网的网络前缀比整个单位的网络前缀更长。
例如，某单位分配到地址块 /20，假定从主机号划出 3 位来划分子网，这样它可以划分为 8 个子网，每个子网的网络前缀就是 23 位。

## 二. 路由聚合（构成超网）

在 CIDR 中，路由表的列项为网络前缀、下一跳地址。

由于采用了 CIDR 方法，所以现在路由表的一项，就可以表示原分类 IP 地址的很多个路由。

比如，路由 $R_1$ 与路由 $R_2$ 相连。路由 $R_2$ 连接 n 个网络，且都是 206.1.0.0/17、206.1.128.0/17、206.1.x.x/17 这样的格式。
那么在原本分类 IP 地址中，需要在路由 $R_1$ 的路由表中，记录路由 $R_2$ 的 n 个网络，使其对应的下一跳地址为路由 $R_2$ 。
而使用 CIDR，则路由 1 的路由表中，只需要记录包含路由 $R_2$ 连接的 n 个 网络的地址块，地址块 206.1.0.0/16（注意这里是 /16 哟），及其对应的下一跳地址为路由 $R_2$。

这样就省去了原本路由表需要记录的大量表项。

所以叫作**路由聚合**，也称为**构成超网**。
我的理解，路由聚合，原本需要记录的大量路由信息，被整合成只需要记录少量几项。构成超网，这种方式看起来就像是把多个网络合并看作一个。

地址块有多种简便写法，反正都是省略主机号。
比如 10.0.0.0/10，可简写为 10/10，也可简写为 00001010 00\*，

## 三. 最长前缀匹配

在使用 CIDR 时，路由转发，查找路由表地址块时，可能会有多个表项匹配。

例如，路由 $R_1$ 的路由表记录：

|    网络前缀     |   下一跳   |
| :-------------: | :--------: |
|  206.0.68.0/22  | 路由 $R_2$ |
| 206.0.71.128/25 | 路由 $R_3$ |

现在路由 $R_1$ 接收到数据报，其目的 IP 地址为 206.0.71.130。
将 206.0.71.130 与路由表中这两个网络前缀的地址掩码进行与运算：

206.0.71.130 & 11111111 11111111 11111100 00000000（22 个 1）= 206.0.68.0/22
206.0.71.130 & 11111111 11111111 11111111 10000000（25 个 1）= 206.0.71.128/25

则两个都是匹配的。
此时我们应该选择后者，即 206.0.71.128/25，将数据报转发给路由 $R_3$ 。
这是因为，更长的匹配说明网络前缀越长，地址块越小，路由越具体。范围越小，越接近目的地址。

从匹配结果中选择最长网络前缀的路由，这叫做**最长前缀匹配（longest-prefix matching）**，又称为**最长匹配**或**最佳匹配**。

So，使用 CIDR 这种方式，可以大大减少路由表中的路由项目。
例如，可以将世界划分为四大地区，每个地区分配一个 CIDR 地址块：

地址块 194/7（194.0.0.0 至 195.255.255.255）分配给欧洲；
地址块 198/7（198.0.0.0 至 199.255.255.255）分配给北美洲；
地址块 200/7（200.0.0.0 至 201.255.255.255）分配给中美洲和南美洲；
地址块 202/7（202.0.0.0 至 203.255.255.255）分配给亚洲和太平洋地区；

不过，在使用 CIDR 之前，互联网已经分配了不少 IP 地址了，然而这些 IP 地址并没有按照地理位置来分配。如果要回收这些 IP 地址，又很困难。所以现实是并非全是按 CIDR 来的。

2021.03.01

做了王道书上的题目，这里补充一下一些东西：

1. 路由器专门为域名服务器 DNS 设定了一个特定的路由表项，因此域名服务器 DNS 的路由表项的子网掩码为 255.255.255.255。

2. 路由器到互联网的路由实际上相当于一个默认路由，即当某一目的网络 IP 地址与路由表中其他任何一项都不匹配时，匹配该默认路由。默认路由一般写为 0/0，即目的地址为 0.0.0.0，子网掩码为 0.0.0.0。

   刚做了真题，看了答案，认为到**互联网的网络前缀就为 0.0.0.0/0**。